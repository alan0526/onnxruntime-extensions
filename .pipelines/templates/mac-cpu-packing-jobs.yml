parameters:
- name: MacosArch
  type: string
  values:
  - 'x86_64'
  - 'arm64'
  - 'universal2'
  default: 'x86_64'

- name: WithCache
  displayName: Build with Cache
  type: boolean
  default: false

- name: AdditionalBuildFlags
  displayName: Additional build flags for build.py
  type: string
  default: ''

- name: CacheDir
  displayName: Cache Directory
  type: string
  default: ''

- name: Today
  type: string
  default: ""


jobs:
- job: MacOS_C_API_Packaging_CPU_${{ parameters.MacosArch }}
  workspace:
    clean: all
  variables:
    MACOSX_DEPLOYMENT_TARGET: '10.14'
    TODAY: $[format('{0:dd}{0:MM}{0:yyyy}', pipeline.startTime)]
  pool:
    vmImage: 'macOS-12'
  timeoutInMinutes: 300
  steps:
  - checkout: self
    clean: true
    submodules: none

  - task: NodeTool@0
    inputs:
      versionSpec: '16.x'

  - template: set-package-version-variable-step.yml
    parameters:
      IsReleaseBuild: true
      PackageVersionVariableName: ORT_EXTENSIONS_VERSION

  - template: mac-build-step-with-cache.yml
    parameters:
      WithCache: ${{ parameters.WithCache }}
      Today: ${{ parameters.Today }}
      AdditionalKey: onnxruntime-extensions_${{ parameters.MacosArch }}
      CacheDir: ${{ parameters.CacheDir }}
      ChangeEveryCommit: true
      BuildStep:
        - script: |
            set -e -x
            cd $(Build.SourcesDirectory)
            rm -rf out/
            ./build.sh -DOCOS_ENABLE_CV2=OFF -DOCOS_ENABLE_BLINGFIRE=OFF ${{parameters.AdditionalBuildFlags}}
            ls out/*
          displayName: 'Build ${{ parameters.MacosArch }}'
          env:
            CCACHE_DIR: ${{ parameters.CacheDir }}

  - task: Bash@3
    displayName: 'Copy build artifacts for zipping'
    inputs:
      targetType: 'inline'
      script: |
        set -e -x
        target_lib_path=onnxruntime-extensions-osx-${{ parameters.MacosArch }}-$(ORT_EXTENSIONS_VERSION)/lib
        mkdir -p $target_lib_path
        cp $(Build.SourcesDirectory)/out/Darwin/RelWithDebInfo/lib/libortextensions.dylib  ${target_lib_path}/
        strip -S ${target_lib_path}/libortextensions.dylib
      workingDirectory: '$(Build.BinariesDirectory)'

  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: '$(Build.BinariesDirectory)/onnxruntime-extensions-osx-${{ parameters.MacosArch }}-$(ORT_EXTENSIONS_VERSION)'
      includeRootFolder: true
      archiveType: 'tar' # Options: zip, 7z, tar, wim
      tarCompression: 'gz'
      archiveFile: '$(Build.ArtifactStagingDirectory)/onnxruntime-extensions-osx-${{ parameters.MacosArch }}.tgz'
      replaceExistingArchive: true


  - publish: '$(Build.ArtifactStagingDirectory)'
    artifact: 'onnxruntime-extensions-osx-${{ parameters.MacosArch }}'